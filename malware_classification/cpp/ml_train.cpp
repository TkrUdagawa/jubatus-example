#include <iostream>
#include <fstream>
#include <exception>
#include <string>

#include <csignal>

#include <jubatus/client.hpp>
#include <jubatus/util/text/json.h>
#include "mist.hpp"

using namespace std;
using namespace jubatus::util::lang;
using jubatus::client::common::datum;
using jubatus::classifier::client::classifier;
using jubatus::classifier::labeled_datum;

namespace {
const string host = "127.0.0.1";
const int port = 9199;
const string kName = "test";
const double kTimeout = 1.0;
}

#define STRING(...) #__VA_ARGS__

int main(int argc, char *argv[])
{
  using jubatus::util::text::json::json;

  // portable code for socket write(2) MSG_NOSIGNAL
  if (signal(SIGPIPE, SIG_IGN) == SIG_ERR) {
    perror("ignore SIGPIPE");
    return -1;
  }

  if (argc < 3) {
    cout << "./ml_train <train.csv> <mist_dir>" << endl;
    return -1;
  }

  try {
    classifier client(host, port, kName, kTimeout);

    // start train
    cerr << "Loading.. " << argv[1] << endl;
    vector<sample_type> targets = load_csv(argv[1]);
    cerr << "Target size: " << targets.size() << endl;

    vector<sample_type>::iterator it = targets.begin(), end = targets.end();
    for (; it != end; ++it) {
      string path = argv[2];
      path += "/";
      path += it->sha1;
      path += ".";
      path += it->label;

      vector<labeled_datum> data;
      datum d = { load_mist(path), vector<pair<string, double> >() };
      data.push_back(labeled_datum(it->label, d));

      client.train(data);
    }

  } catch (const msgpack::rpc::rpc_error& e) {
    cerr << "rpc_error: " << e.what() << endl;
  } catch (const exception& e) {
    cerr << "error: " << e.what() << endl;
  } catch (...) {
    cerr << "unhandled exception raised" << endl;
  }

  return 0;
}
